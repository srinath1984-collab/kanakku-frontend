<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Kanakku - Personalized Expenses</title>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
    :root {
        --bg-color: #121212;
        --card-bg: #1e1e1e;
        --text-main: #e0e0e0;
        --text-dim: #a0a0a0;
        --accent: #bb86fc; /* Modern Purple */
        --accent-hover: #9965f4;
        --danger: #cf6679; /* Soft Red for Sign Out */
    }

    body { 
        font-family: 'Inter', -apple-system, sans-serif; 
        background: var(--bg-color); 
        color: var(--text-main);
        margin: 0; padding: 20px; 
        display: flex; justify-content: center;
    }

    .container { max-width: 900px; width: 100%; }

    .card { 
        background: var(--card-bg); 
        padding: 30px; 
        border-radius: 16px; 
        box-shadow: 0 10px 30px rgba(0,0,0,0.5); 
        margin-bottom: 25px;
        border: 1px solid rgba(255, 255, 255, 0.05); /* Subtle edge */
    }

    h1, h2 { margin-top: 0; font-weight: 700; letter-spacing: -0.5px; }
    h1 { color: var(--accent); }

    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }

    /* Modern Buttons */
    button { 
        background: var(--accent); 
        color: #000; 
        border: none; 
        padding: 12px 24px; 
        border-radius: 10px; 
        cursor: pointer; 
        font-weight: 600; 
        transition: transform 0.2s, background 0.2s;
    }

    button:hover { 
        background: var(--accent-hover); 
        transform: translateY(-2px); 
    }

    .signout-btn { background: transparent; color: var(--danger); border: 1px solid var(--danger); }
    .signout-btn:hover { background: var(--danger); color: #000; }

    /* File Dropzone */
    .dropzone { 
        border: 2px dashed rgba(255, 255, 255, 0.1); 
        padding: 40px; 
        text-align: center; 
        border-radius: 12px; 
        background: rgba(255, 255, 255, 0.02);
        transition: border-color 0.3s;
    }
    .dropzone:hover { border-color: var(--accent); }

    /* Summary Items */
    .summary-item { 
        display: flex; justify-content: space-between; 
        padding: 12px 0; 
        border-bottom: 1px solid rgba(255, 255, 255, 0.05); 
    }
    .summary-item strong { color: var(--accent); }
</style>
</head>
<body>

<div class="container">
    <div class="card" style="text-align: center;" id="login-card">
        <h1>Kanakku</h1>
        <div id="g_id_onload" data-client_id="940001353287-3mu3k6jd76haav5dn6tfemu46mk76dnt.apps.googleusercontent.com" data-callback="handleLogin"></div>
        <div class="g_id_signin" data-type="standard"></div>
    </div>

    <div id="app-content">
        <div class="card">
            <div class="user-info">
                <span>Logged in as: <strong id="user-display"></strong></span>
                <button class="signout-btn" onclick="signOut()">Sign Out</button>
            </div>
        </div>

        <div class="grid">
            <div class="card">
                <h2>Dashboard</h2>
               <select id="month-picker" onchange="fetchSummary()">
                <option value="">Select Month</option>
                </select>
                <div id="summary-list">Loading summary...</div>
                <button onclick="fetchSummary()" style="margin-top:15px;">Refresh Totals</button>
            </div>

            <div class="card">
                <h2>Custom Rules</h2>
                <div id="rules-list"></div>
                <hr>
                <p><strong>Add New Rule:</strong></p>
                <input type="text" id="new-keyword" placeholder="Keywords (comma separated)">
                <input type="text" id="new-category" placeholder="Category Name">
                <button onclick="addRule()">Add Rule</button>
            </div>
        </div>

        <div class="card">
            <h2>Upload Monthly Files</h2>
            <div class="dropzone" onclick="document.getElementById('fileInput').click()">
                <input type="file" id="fileInput" multiple accept=".csv" style="display:none" onchange="uploadFiles()">
                Drag & Drop or Click to select CSV files
            </div>
            <p id="upload-status" style="text-align:center; color: #666;"></p>
        </div>
        <div class="card">
    <h2>User Preferences</h2>
    <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 10px;">
        <div>
            <label>Currency:</label>
            <select id="pref-currency">
                <option value="₹">₹ (INR)</option>
                <option value="$">$ (USD)</option>
                <option value="€">€ (EUR)</option>
            </select>
        </div>
        <div>
            <label>Date Format:</label>
            <select id="pref-dayfirst">
                <option value="true">DD-MM-YYYY (India/UK)</option>
                <option value="false">MM-DD-YYYY (USA)</option>
            </select>
        </div>
    </div>
    <button onclick="savePreferences()" style="margin-top: 15px; width: 100%;">Save Settings</button>
</div>
    </div>
</div>

<script>
    const BACKEND = "https://kanakku-940001353287.us-west1.run.app";
    let userToken = "";

    async function savePreferences() {
    const prefs = {
        currency: document.getElementById('pref-currency').value,
        dayfirst: document.getElementById('pref-dayfirst').value === "true"
    };

    await fetch(`${BACKEND}/preferences`, {
        method: 'POST',
        headers: { 
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${userToken}` 
        },
        body: JSON.stringify(prefs)
    });
    alert("Preferences saved! Re-upload files for date changes to take effect.");
    fetchSummary(); // Refresh to update currency symbols
}
    
function formatMonth(monthKey) {
    const [year, month] = monthKey.split('-');
    const date = new Date(year, month - 1);
    return date.toLocaleString('default', { month: 'long', year: 'numeric' });
}

// In loadMonthPicker():
picker.innerHTML = data.months.map(m => `<option value="${m}">${formatMonth(m)}</option>`).join('');
    // Run this when the user logs in
async function loadMonthPicker() {
    const res = await fetch(`${BACKEND}/available-months`, {
        headers: { 'Authorization': `Bearer ${userToken}` }
    });
    const data = await res.json();
    const picker = document.getElementById('month-picker');
    
    // Clear existing options and add new ones from DB
picker.innerHTML = data.months.map(m => `<option value="${m}">${formatMonth(m)}</option>`).join('');    
    // Automatically trigger the first summary fetch
    if (data.months.length > 0) {
        picker.value = data.months[0];
        fetchSummary();
    }
}


    function handleLogin(response) {
        userToken = response.credential;
        
        // Decode the JWT locally to show user email
        try {
            const payload = JSON.parse(atob(userToken.split('.')[1]));
            document.getElementById('user-display').innerText = payload.email;
                loadMonthPicker(); // <--- Initialize the picker first

        } catch (e) {
            console.error("Token decode error", e);
        }

        document.getElementById('login-card').style.display = 'none';
        document.getElementById('app-content').style.display = 'block';
        syncPreferences();
    }

    function signOut() {
        // Clear variables
        userToken = "";
        
        // Disable Google auto-select so the picker shows up again
        google.accounts.id.disableAutoSelect();
        
        // UI Reset
        document.getElementById('app-content').style.display = 'none';
        document.getElementById('login-card').style.display = 'block';
        
        // Optional: Refresh page to clear all states
        window.location.reload();
    }

    async function syncPreferences() {
    try {
        const res = await fetch(`${BACKEND}/preferences`, {
            headers: { 'Authorization': `Bearer ${userToken}` }
        });
        
        if (res.ok) {
            userPrefs = await res.json();
            
            // --- The Critical Sync Part ---
            // This sets the dropdowns to match your saved DB values
            if (userPrefs.currency) {
                document.getElementById('pref-currency').value = userPrefs.currency;
            }
            
            if (userPrefs.dayfirst !== undefined) {
                // We convert the boolean to a string to match the <option value="true/false">
                document.getElementById('pref-dayfirst').value = userPrefs.dayfirst.toString();
            }
            
            // Update the UI labels/badges
            const dateFormat = userPrefs.dayfirst ? "DD-MM (India/UK)" : "MM-DD (USA)";
            console.log(`Synced: ${userPrefs.currency} and ${dateFormat}`);
            
            // Update dashboard display
            fetchSummary();
        }
    } catch (e) {
        console.error("Failed to sync preferences", e);
    }
}

    async function fetchSummary() {
        if (!userToken) return;
        try {
            const prefsRes = await fetch(`${BACKEND}/preferences`, {
    headers: { 'Authorization': `Bearer ${userToken}` }
});
const prefs = await prefsRes.json();
const currencySymbol = prefs.currency || "₹";
            const selectedMonth = document.getElementById('month-picker').value;
            const res = await fetch(`${BACKEND}/summary?month=${selectedMonth}`, {
                headers: { 'Authorization': `Bearer ${userToken}` }
            });
            const data = await res.json();
            const list = document.getElementById('summary-list');
            list.innerHTML = Object.entries(data).length > 0 
                ? Object.entries(data).map(([cat, amt]) => `
                    <div class="summary-item">
                        <span>${cat}</span>
                        <strong>${currencySymbol}${amt.toFixed(2)}</strong>
                    </div>`).join('')
                : "No data yet. Upload some files!";
        } catch (e) { console.error("Summary error", e); }
    }

    async function uploadFiles() {
        const input = document.getElementById('fileInput');
        if (input.files.length === 0) return;

        const formData = new FormData();
        for (let f of input.files) formData.append('files', f);

        document.getElementById('upload-status').innerText = "Uploading to GCP & Categorizing...";
        
        try {
            const res = await fetch(`${BACKEND}/upload`, {
                method: 'POST',
                body: formData,
                headers: { 'Authorization': `Bearer ${userToken}` }
            });
            const blob = await res.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = "categorized_expenses.csv";
            a.click();
            
            document.getElementById('upload-status').innerText = "Upload Complete! Refreshing dashboard...";
            setTimeout(fetchSummary, 2000);
        } catch (e) {
            alert("Upload failed.");
            document.getElementById('upload-status').innerText = "";
        }
    }

    async function addRule() {
        const kw = document.getElementById('new-keyword').value;
        const cat = document.getElementById('new-category').value;
        if (!kw || !cat) return alert("Fill both fields");
        alert("Rule saved for future uploads!");
    }
</script>

</body>
</html>
